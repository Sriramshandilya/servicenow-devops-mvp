name: CI/CD Pipeline with ServiceNow Change

on:
  push:
    branches:
      - main

jobs:

  plan:
    name: Plan
    runs-on: ubuntu-latest
    steps:
      - name: Planning stage
        run: |
          echo "ğŸ“‹ Planning deployment..."
          echo "Checking scope, impact, dependencies"
          sleep 5
          echo "âœ… Plan completed"

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: plan
    steps:
      - name: Build stage
        run: |
          echo "ğŸ—ï¸ Building application..."
          sleep 5
          echo "âœ… Build successful"

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Test stage
        run: |
          echo "ğŸ§ª Running tests..."
          sleep 5
          echo "âœ… Tests passed"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Simulate deployment
        run: |
          echo "ğŸš€ Deploying application..."
          sleep 5
          echo "âœ… Deployment completed"

      - name: ServiceNow DevOps Change (Async)
        uses: ServiceNow/servicenow-devops-change@main
        with:
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          devops-integration-token: ${{ secrets.SN_TOKEN }}
          job-name: Deploy to Production

          # ğŸ”‘ Async / Non-blocking
          abortOnChangeCreationFailure: false
          abortOnChangeStepTimeout: false
          changeCreationTimeout: 10
